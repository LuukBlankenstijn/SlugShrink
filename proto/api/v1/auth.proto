syntax = "proto3";

package api.v1;

import "buf/validate/validate.proto";

enum UserPermission {
  PERMISSION_UNSPECIFIED = 0;
  PERMISSION_USER = 1;
  PERMISSION_SUPERUSER = 2;
  PERMISSION_ADMIN = 3;
  PERMISSION_CREATOR = 4;
}

message Authenticated {
  UserPermission permission = 1;
  optional string user_id = 2;
}

message Unauthenticated {}

message AuthStatus {
  oneof status {
    Authenticated authenticated = 1;
    Unauthenticated unauthenticated = 2;
  }
}

message BasicAuthLogin {
  string password = 1;
}

message SetAuthless {}

message SetBasicAuth {
  string password = 1 [(buf.validate.field).string = {
    min_len: 8
    max_len: 128
  }];

  string repeated_password = 2 [(buf.validate.field).string = {
    min_len: 8
    max_len: 128
  }];

  option (buf.validate.message).cel = {
    id: "passwords_match"
    message: "password and repeated_password must be the same"
    expression: "this.password == this.repeated_password"
  };

  option (buf.validate.message).cel = {
    id: "password_strength"
    message: "password must contain upper, lower, digit, and special character"
    expression: "this.password.matches('.*[a-z].*') && this.password.matches('.*[A-Z].*') && this.password.matches('.*[0-9].*') && this.password.matches('.*[^A-Za-z0-9].*')"
  };
}

message SetProxyAuth {
  string group_header = 1 [(buf.validate.field).string.min_len = 1];
  string user_id_header = 2;
  repeated string super_user_groups = 3;
  repeated string admin_groups = 4 [(buf.validate.field).repeated.min_items = 1];
  optional string groups_separator = 5;
}

message SetAuth {
  oneof config {
    SetAuthless authless = 1;
    SetBasicAuth basic_auth = 2;
    SetProxyAuth proxy_auth = 3;
  }
}

message Authless {}

message BasicAuth {}

message ProxyAuth {
  string group_header = 1;
  string user_id_header = 2;
  repeated string super_user_groups = 3;
  repeated string admin_groups = 4;
  optional string groups_separator = 5;
}

message GetAuth {
  oneof config {
    Authless authless = 1;
    BasicAuth basic_auth = 2;
    ProxyAuth proxy_auth = 3;
  }
}
